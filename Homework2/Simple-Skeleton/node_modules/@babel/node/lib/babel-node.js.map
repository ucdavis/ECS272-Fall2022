{"version":3,"names":["args","path","join","dirname","babelArgs","process","argv","slice","userArgs","argSeparator","indexOf","getNormalizedV8Flag","arg","matches","match","replace","aliases","Map","getV8Flags","err","v8Flags","i","length","flag","split","push","has","unshift","get","default","kexec","code","shouldPassthroughIPC","send","undefined","proc","child_process","spawn","stdio","on","signal","kill","pid","exitCode","message"],"sources":["../src/babel-node.ts"],"sourcesContent":["/**\n * This tiny wrapper file checks for known node flags and appends them\n * when found, before invoking the \"real\" _babel-node(1) executable.\n */\n\nimport getV8Flags from \"v8flags\";\nimport path from \"path\";\nimport child_process from \"child_process\";\nimport { fileURLToPath } from \"url\";\n\nconst args = [\n  path.join(path.dirname(fileURLToPath(import.meta.url)), \"_babel-node\"),\n];\n\nlet babelArgs = process.argv.slice(2);\nlet userArgs: string[];\n\n// separate node arguments from script arguments\nconst argSeparator = babelArgs.indexOf(\"--\");\nif (argSeparator > -1) {\n  userArgs = babelArgs.slice(argSeparator); // including the  --\n  babelArgs = babelArgs.slice(0, argSeparator);\n}\n\n/**\n * Replace dashes with underscores in the v8Flag name\n * Also ensure that if the arg contains a value (e.g. --arg=true)\n * that only the flag is returned.\n */\nfunction getNormalizedV8Flag(arg: string) {\n  // v8 uses the \"no\" prefix to negate boolean flags (e.g. --nolazy),\n  // but they are not listed by v8flags\n  const matches = arg.match(/--(?:no)?(.+)/);\n\n  if (matches) {\n    return `--${matches[1].replace(/-/g, \"_\")}`;\n  }\n\n  return arg;\n}\n\n// These are aliases for node options defined by babel-node.\nconst aliases = new Map([\n  [\"-d\", \"--debug\"],\n  [\"-gc\", \"--expose-gc\"],\n]);\n\ngetV8Flags(async function (err, v8Flags) {\n  for (let i = 0; i < babelArgs.length; i++) {\n    const arg = babelArgs[i];\n    const flag = arg.split(\"=\")[0];\n\n    if (flag === \"-r\" || flag === \"--require\") {\n      args.push(flag);\n      args.push(babelArgs[++i]);\n    } else if (aliases.has(flag)) {\n      args.unshift(aliases.get(flag) as string);\n    } else if (\n      flag === \"debug\" || // node debug foo.js\n      flag === \"inspect\" ||\n      v8Flags.indexOf(getNormalizedV8Flag(flag)) >= 0 ||\n      process.allowedNodeEnvironmentFlags.has(flag)\n    ) {\n      args.unshift(arg);\n    } else {\n      args.push(arg);\n    }\n  }\n\n  // append arguments passed after --\n  if (argSeparator > -1) {\n    args.push(...userArgs);\n  }\n\n  try {\n    const { default: kexec } = await import(\"kexec\");\n    kexec(process.argv[0], args);\n  } catch (err) {\n    if (\n      err.code !== \"ERR_MODULE_NOT_FOUND\" &&\n      err.code !== \"MODULE_NOT_FOUND\" &&\n      err.code !== \"UNDECLARED_DEPENDENCY\"\n    ) {\n      throw err;\n    }\n\n    // passthrough IPC only if babel-node itself has an IPC channel\n    const shouldPassthroughIPC = process.send !== undefined;\n    const proc = child_process.spawn(process.argv[0], args, {\n      stdio: shouldPassthroughIPC\n        ? [\"inherit\", \"inherit\", \"inherit\", \"ipc\"]\n        : \"inherit\",\n    });\n    proc.on(\"exit\", function (code, signal) {\n      process.on(\"exit\", function () {\n        if (signal) {\n          process.kill(process.pid, signal);\n        } else {\n          process.exitCode = code ?? undefined;\n        }\n      });\n    });\n    if (shouldPassthroughIPC) {\n      proc.on(\"message\", message => process.send(message));\n    }\n    process.on(\"SIGINT\", () => proc.kill(\"SIGINT\"));\n    process.on(\"SIGTERM\", () => proc.kill(\"SIGTERM\"));\n  }\n});\n"],"mappings":"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"}