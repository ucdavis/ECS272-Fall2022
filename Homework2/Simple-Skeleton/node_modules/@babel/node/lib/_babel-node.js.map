{"version":3,"names":["program","commander","Command","collect","value","previousValue","values","split","push","option","version","usage","parse","process","argv","babelOptions","caller","name","extensions","ignore","only","plugins","presets","configFile","envName","rootMode","babelrc","undefined","key","Object","keys","register","replPlugin","types","t","visitor","ModuleDeclaration","path","buildCodeFrameError","VariableDeclaration","node","kind","Program","get","some","child","isExpressionStatement","pushContainer","expressionStatement","identifier","_eval","code","filename","trim","babel","transformSync","concat","vm","runInThisContext","eval","print","global","__filename","__dirname","cwd","module","Module","paths","_nodeModulePaths","exports","require","bind","result","output","inspect","stdout","write","args","length","slice","i","ignoreNext","arg","i2","parsedOption","options","find","long","short","optionName","attributeName","parsedArg","requireArgs","isAbsolute","join","execArgv","runMain","replStart","replEval","context","callback","err","e","replServer","repl","start","prompt","input","stdin","useGlobal","preview","NODE_REPL_HISTORY","env","setupHistory"],"sources":["../src/_babel-node.ts"],"sourcesContent":["import commander from \"commander\";\nimport Module from \"module\";\nimport { inspect } from \"util\";\nimport path from \"path\";\nimport repl from \"repl\";\nimport * as babel from \"@babel/core\";\nimport vm from \"vm\";\nimport \"core-js/stable/index\";\nimport \"regenerator-runtime/runtime\";\n// @ts-expect-error @babel/register is a CommonJS module\nimport register from \"@babel/register\";\nimport { fileURLToPath } from \"url\";\nimport { createRequire } from \"module\";\n\nimport type { PluginAPI, PluginObject } from \"@babel/core\";\nimport type { REPLEval } from \"repl\";\n\nconst require = createRequire(import.meta.url);\n\nconst program = new commander.Command(\"babel-node\");\n\nfunction collect(value: unknown, previousValue: string[]): Array<string> {\n  // If the user passed the option with no value, like \"babel-node file.js --presets\", do nothing.\n  if (typeof value !== \"string\") return previousValue;\n\n  const values = value.split(\",\");\n\n  if (previousValue) {\n    previousValue.push(...values);\n    return previousValue;\n  }\n  return values;\n}\n\nprogram.option(\"-e, --eval [script]\", \"Evaluate script\");\nprogram.option(\n  \"--no-babelrc\",\n  \"Specify whether or not to use .babelrc and .babelignore files\",\n);\nprogram.option(\"-r, --require [module]\", \"Require module\");\nprogram.option(\"-p, --print [code]\", \"Evaluate script and print result\");\nprogram.option(\n  \"-o, --only [globs]\",\n  \"A comma-separated list of glob patterns to compile\",\n  collect,\n);\nprogram.option(\n  \"-i, --ignore [globs]\",\n  \"A comma-separated list of glob patterns to skip compiling\",\n  collect,\n);\nprogram.option(\n  \"-x, --extensions [extensions]\",\n  \"List of extensions to hook into [.es6,.js,.es,.jsx,.mjs]\",\n  collect,\n);\nprogram.option(\n  \"--config-file [path]\",\n  \"Path to the babel config file to use. Defaults to working directory babel.config.js\",\n);\nprogram.option(\n  \"--env-name [name]\",\n  \"The name of the 'env' to use when loading configs and plugins. \" +\n    \"Defaults to the value of BABEL_ENV, or else NODE_ENV, or else 'development'.\",\n);\nprogram.option(\n  \"--root-mode [mode]\",\n  \"The project-root resolution mode. \" +\n    \"One of 'root' (the default), 'upward', or 'upward-optional'.\",\n);\nprogram.option(\"-w, --plugins [string]\", \"\", collect);\nprogram.option(\"-b, --presets [string]\", \"\", collect);\n\ndeclare const PACKAGE_JSON: { name: string; version: string };\nprogram.version(PACKAGE_JSON.version);\nprogram.usage(\"[options] [ -e script | script.js ] [arguments]\");\nprogram.parse(process.argv);\n\nconst babelOptions = {\n  caller: {\n    name: \"@babel/node\",\n  },\n  extensions: program.extensions,\n  ignore: program.ignore,\n  only: program.only,\n  plugins: program.plugins,\n  presets: program.presets,\n  configFile: program.configFile,\n  envName: program.envName,\n  rootMode: program.rootMode,\n\n  // Commander will default the \"--no-\" arguments to true, but we want to\n  // leave them undefined so that @babel/core can handle the\n  // default-assignment logic on its own.\n  babelrc: program.babelrc === true ? undefined : program.babelrc,\n};\n\nfor (const key of Object.keys(babelOptions) as Array<\n  keyof typeof babelOptions\n>) {\n  if (babelOptions[key] === undefined) {\n    delete babelOptions[key];\n  }\n}\n\nregister(babelOptions);\n\nconst replPlugin = ({ types: t }: PluginAPI): PluginObject => ({\n  visitor: {\n    ModuleDeclaration(path) {\n      throw path.buildCodeFrameError(\"Modules aren't supported in the REPL\");\n    },\n\n    VariableDeclaration(path) {\n      if (path.node.kind !== \"var\") {\n        throw path.buildCodeFrameError(\n          \"Only `var` variables are supported in the REPL\",\n        );\n      }\n    },\n\n    Program(path) {\n      if (path.get(\"body\").some(child => child.isExpressionStatement())) return;\n\n      // If the executed code doesn't evaluate to a value,\n      // prevent implicit strict mode from printing 'use strict'.\n      path.pushContainer(\n        \"body\",\n        t.expressionStatement(t.identifier(\"undefined\")),\n      );\n    },\n  },\n});\n\nconst _eval = function (code: string, filename: string) {\n  code = code.trim();\n  if (!code) return undefined;\n\n  code = babel.transformSync(code, {\n    filename: filename,\n    presets: program.presets,\n    plugins: (program.plugins || []).concat([replPlugin]),\n  }).code;\n\n  return vm.runInThisContext(code, {\n    filename: filename,\n  });\n};\n\nif (program.eval || program.print) {\n  let code = program.eval;\n  if (!code || code === true) code = program.print;\n\n  global.__filename = \"[eval]\";\n  global.__dirname = process.cwd();\n\n  const module = new Module(global.__filename);\n  module.filename = global.__filename;\n  // @ts-expect-error todo(flow->ts)\n  module.paths = Module._nodeModulePaths(global.__dirname);\n\n  global.exports = module.exports;\n  global.module = module;\n  global.require = module.require.bind(module);\n\n  const result = _eval(code, global.__filename);\n  if (program.print) {\n    const output = typeof result === \"string\" ? result : inspect(result);\n    process.stdout.write(output + \"\\n\");\n  }\n} else {\n  if (program.args.length) {\n    // slice all arguments up to the first filename since they're babel args that we handle\n    let args = process.argv.slice(2);\n\n    let i = 0;\n    let ignoreNext = false;\n    args.some(function (arg, i2) {\n      if (ignoreNext) {\n        ignoreNext = false;\n        return;\n      }\n\n      if (arg[0] === \"-\") {\n        const parsedOption = program.options.find((option: any) => {\n          return option.long === arg || option.short === arg;\n        });\n        if (parsedOption === undefined) {\n          return;\n        }\n        const optionName = parsedOption.attributeName();\n        const parsedArg = program[optionName];\n        if (optionName === \"require\" || (parsedArg && parsedArg !== true)) {\n          ignoreNext = true;\n        }\n      } else {\n        i = i2;\n        return true;\n      }\n    });\n    args = args.slice(i);\n\n    requireArgs();\n\n    // make the filename absolute\n    const filename = args[0];\n    if (!path.isAbsolute(filename)) {\n      args[0] = path.join(process.cwd(), filename);\n    }\n\n    // add back on node and concat the sliced args\n    process.argv = [\"node\", ...args];\n    process.execArgv.push(fileURLToPath(import.meta.url));\n\n    Module.runMain();\n  } else {\n    requireArgs();\n    replStart();\n  }\n}\n\n// We have to handle require ourselves, as we want to require it in the context of babel-register\nfunction requireArgs() {\n  if (program.require) {\n    require(require.resolve(program.require, {\n      paths: [process.cwd()],\n    }));\n  }\n}\n\nconst replEval: REPLEval = function (code, context, filename, callback) {\n  let err;\n  let result;\n\n  try {\n    if (code[0] === \"(\" && code[code.length - 1] === \")\") {\n      code = code.slice(1, -1); // remove \"(\" and \")\"\n    }\n\n    result = _eval(code, filename);\n  } catch (e) {\n    err = e;\n  }\n\n  callback(err, result);\n};\n\nfunction replStart() {\n  const replServer = repl.start({\n    prompt: \"babel > \",\n    input: process.stdin,\n    output: process.stdout,\n    eval: replEval,\n    useGlobal: true,\n    preview: true,\n  });\n  const NODE_REPL_HISTORY = process.env.NODE_REPL_HISTORY as string;\n  if (process.env.BABEL_8_BREAKING) {\n    replServer.setupHistory(NODE_REPL_HISTORY, () => {});\n  } else {\n    replServer.setupHistory?.(NODE_REPL_HISTORY, () => {});\n  }\n}\n"],"mappings":"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"}